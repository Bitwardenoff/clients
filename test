BRANCH_OR_TAG_LOWER=""
if [ -z "$2" ]; then
  BRANCH_OR_TAG_LOWER=$(echo "sample_branch" | awk '{print tolower($0)}')
else
  BRANCH_OR_TAG_LOWER=$(gh api /repos/bitwarden/clients/actions/runs/$2/artifacts --jq '.artifacts[0].workflow_run.head_branch' | awk '{print tolower($0)}')
fi

PROD_ENV_PATTERN='USPROD|EUPROD'
PROD_ALLOWED_TAGS_PATTERN='web-v[0-9]+\.[0-9]+\.[0-9]+'
QA_ENV_PATTERN='USQA|EUQA'
QA_ALLOWED_TAGS_PATTERN='.*'
DEV_ENV_PATTERN='USDEV'
DEV_ALLOWED_TAGS_PATTERN='main'
if [[ \
    $1 =~ \.*($PROD_ENV_PATTERN)\.* && \
    ! "$BRANCH_OR_TAG_LOWER" =~ ^($PROD_ALLOWED_TAGS_PATTERN).* \
]] || [[ \
    $1 =~ \.*($QA_ENV_PATTERN)\.* && \
    ! "$BRANCH_OR_TAG_LOWER" =~ ^($QA_ALLOWED_TAGS_PATTERN).* \
]] || [[ \
    $1 =~ \.*($DEV_ENV_PATTERN)\.* && \
    ! "$BRANCH_OR_TAG_LOWER" =~ ^($DEV_ALLOWED_TAGS_PATTERN).* \
]]; then
    echo "!Deployment blocked!"
    echo "Attempting to deploy a tag that is not allowed in $1 environment"
    echo
    echo "Environment: $1"
    echo "Tag: $BRANCH_OR_TAG_LOWER"
    exit 1
else
    echo "The input Branch/Tag: '$BRANCH_OR_TAG_LOWER' is allowed to deploy on $1 environment"
fi
